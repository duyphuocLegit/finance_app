{% extends "base.html" %}
{% block content %}
<style>
    /* General Styles */
body {
    font-family: 'Arial', sans-serif;
    background-color: #f8f9fa;
}

/* Nav Tabs */
.nav-tabs .nav-link {
    color: #495057;
    font-size: 1.1rem;
    font-weight: bold;
}

.nav-tabs .nav-link.active {
    background-color: #007bff;
    color: #fff;
    border-color: #007bff;
}

/* Card Styles */
.card {
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.card-header {
    font-size: 1.2rem;
    font-weight: bold;
}

.card-title {
    font-size: 2rem;
    font-weight: bold;
}

/* Table Styles */
.table {
    margin-top: 20px;
}

.table th, .table td {
    font-size: 1rem;
    vertical-align: middle;
}

.table th {
    background-color: #007bff;
    color: #fff;
}

.table tbody tr:nth-child(odd) {
    background-color: #f2f2f2;
}

.table tbody tr:hover {
    background-color: #e9ecef;
}

/* Button Styles */
.btn {
    font-size: 1rem;
    font-weight: bold;
}

.edit-btn, .apply-btn, .cancel-btn {
    margin-right: 5px;
}

.edit-btn {
    background-color: #ffc107;
    color: #fff;
}

.apply-btn {
    background-color: #28a745;
    color: #fff;
}

.cancel-btn {
    background-color: #dc3545;
    color: #fff;
}

a{
    color: #ffffff;
    text-decoration: none;
}
</style>
<h2 class="mb-4">Dashboard</h2>

<!-- Nav tabs -->
<ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab" aria-controls="overview" aria-selected="true">Overview</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="detail-tab" data-toggle="tab" href="#detail" role="tab" aria-controls="detail" aria-selected="false">Detail</a>
    </li>
</ul>

<!-- Tab panes -->
<div class="tab-content">
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-success mb-3" data-toggle="modal" data-target="#pieChartModal" data-type="income">
                    <div class="card-header">Total Incomes</div>
                    <div class="card-body">
                        <h5 class="card-title">{{ total_income }}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-danger mb-3" data-toggle="modal" data-target="#pieChartModal" data-type="expense">
                    <div class="card-header">Total Expenses</div>
                    <div class="card-body">
                        <h5 class="card-title">{{ total_expenses }}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-white bg-info mb-3">
                    <div class="card-header">Balance</div>
                    <div class="card-body">
                        <h5 class="card-title">{{ balance }}</h5>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal -->
        <div class="modal fade" id="pieChartModal" tabindex="-1" role="dialog" aria-labelledby="pieChartModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pieChartModalLabel">Pie Chart</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <img id="pieChartImage" src="" alt="Pie Chart" class="img-fluid">
                    </div>
                </div>
            </div>
        </div>
        
        <h3>Income and Expense Chart</h3>
<canvas id="incomeExpenseChart"></canvas>
    </div>
    <div class="tab-pane fade" id="detail" role="tabpanel" aria-labelledby="detail-tab">
        <!-- Filter Icon -->
<div id="filter-icon" class="mb-3">
    <i class="fas fa-filter" style="cursor: pointer;"></i>
</div>

<!-- Filter Form -->
<div id="filter-form" style="display: none;">
    <h3>Filter Transactions</h3>
    <form method="POST" action="{{ url_for('dashboard') }}">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.category.label }} {{ form.category(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.start_date.label }} {{ form.start_date(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.end_date.label }} {{ form.end_date(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>

<h3>Transactions</h3>
{% if transactions %}
<table class="table table-striped">
    <thead>
        <tr>
            <th><a href="#" id="sort-title" class="sort-link">Title</a></th>
            <th><a href="#" id="sort-amount" class="sort-link">Amount</a></th>
            <th><a href="#" id="sort-type" class="sort-link">Type</a></th>
            <th><a href="#" id="sort-category" class="sort-link">Category</a></th>
            <th><a href="#" id="sort-date" class="sort-link">Date</a></th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="transactions-body">
        {% for transaction in transactions %}
        <tr id="transaction-{{ transaction.id }}">
            <td>
                <span class="transaction-title">{{ transaction.title }}</span>
                <input type="text" class="form-control transaction-title-input" value="{{ transaction.title }}" style="display:none;">
            </td>
            <td>
                <span class="transaction-amount">{{ transaction.amount }}</span>
                <input type="number" class="form-control transaction-amount-input" value="{{ transaction.amount }}" style="display:none;">
            </td>
            <td>
                <span class="transaction-type">{{ transaction.type }}</span>
                <select class="form-control transaction-type-input" style="display:none;">
                    <option value="Income" {% if transaction.type == 'Income' %}selected{% endif %}>Income</option>
                    <option value="Expense" {% if transaction.type == 'Expense' %}selected{% endif %}>Expense</option>
                </select>
            </td>
            
            <td>
                <span class="transaction-category">{{ transaction.category }}</span>
                <select class="form-control transaction-category-input" style="display:none;">
                    <!-- Options will be dynamically populated by JavaScript -->
                </select>
            </td>
            <td>
                <span class="transaction-date">{{ transaction.date.strftime('%Y-%m-%d') }}</span>
                <input type="date" class="form-control transaction-date-input" value="{{ transaction.date.strftime('%Y-%m-%d') }}" style="display:none;">
            </td>
            <td>
                <button class="btn btn-sm edit-btn btn-outline-primary" onclick="editTransaction('{{ transaction.id }}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-success btn-sm apply-btn" onclick="applyTransaction('{{ transaction.id }}')" style="display:none;"><i class="fas fa-check"></i></button>
                <button class="btn btn-secondary btn-sm cancel-btn" onclick="cancelTransaction('{{ transaction.id }}')" style="display:none;"><i class="fas fa-times"></i></button>
                <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" method="POST" style="display:inline;">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-gray-500">No transactions found.</p>
{% endif %}

<div class="pagination-wrapper">
    {{ pagination.links }}
</div>

<a href="{{ url_for('add_transaction') }}" class="btn btn-primary">Add Transaction</a>
    </div>
</div>
<script>
    function editTransaction(id) {
        document.querySelector(`#transaction-${id} .transaction-title`).style.display = 'none';
        document.querySelector(`#transaction-${id} .transaction-amount`).style.display = 'none';
        document.querySelector(`#transaction-${id} .transaction-type`).style.display = 'none';
        document.querySelector(`#transaction-${id} .transaction-category`).style.display = 'none';
        document.querySelector(`#transaction-${id} .transaction-date`).style.display = 'none';
        document.querySelector(`#transaction-${id} .edit-btn`).style.display = 'none';
    
        document.querySelector(`#transaction-${id} .transaction-title-input`).style.display = 'block';
        document.querySelector(`#transaction-${id} .transaction-amount-input`).style.display = 'block';
        document.querySelector(`#transaction-${id} .transaction-type-input`).style.display = 'block';
        document.querySelector(`#transaction-${id} .transaction-category-input`).style.display = 'block';
        document.querySelector(`#transaction-${id} .transaction-date-input`).style.display = 'block';
        document.querySelector(`#transaction-${id} .apply-btn`).style.display = 'inline-block';
        document.querySelector(`#transaction-${id} .cancel-btn`).style.display = 'inline-block';
    
        const typeSelect = document.querySelector(`#transaction-${id} .transaction-type-input`);
        const categorySelect = document.querySelector(`#transaction-${id} .transaction-category-input`);
    
        const categories = {
            'Income': ['salary', 'investment', 'gift'],
            'Expense': ['food', 'study', 'work', 'exercise', 'leisure']
        };
    
        function updateCategories() {
            const selectedType = typeSelect.value;
            const options = categories[selectedType] || [];
            categorySelect.innerHTML = '';
            options.forEach(function(option) {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option.charAt(0).toUpperCase() + option.slice(1);
                categorySelect.appendChild(opt);
            });
        }
    
        typeSelect.addEventListener('change', updateCategories);
        updateCategories(); // Initial call to set the categories based on the default type
    }
    
    function applyTransaction(id) {
        const title = document.querySelector(`#transaction-${id} .transaction-title-input`).value;
        const amount = document.querySelector(`#transaction-${id} .transaction-amount-input`).value;
        const type = document.querySelector(`#transaction-${id} .transaction-type-input`).value;
        const category = document.querySelector(`#transaction-${id} .transaction-category-input`).value;
        const date = document.querySelector(`#transaction-${id} .transaction-date-input`).value;
    
        fetch(`/edit_transaction/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                title: title,
                amount: amount,
                type: type,
                category: category,
                date: date
            })
        }).then(response => {
            if (response.ok) {
                document.querySelector(`#transaction-${id} .transaction-title`).textContent = title;
                document.querySelector(`#transaction-${id} .transaction-amount`).textContent = amount;
                document.querySelector(`#transaction-${id} .transaction-type`).textContent = type;
                document.querySelector(`#transaction-${id} .transaction-category`).textContent = category;
                document.querySelector(`#transaction-${id} .transaction-date`).textContent = date;
    
                cancelTransaction(id);
                location.reload()
            } else {
                alert('Failed to update transaction.');
            }
        });
    }

function cancelTransaction(id) {
    document.querySelector(`#transaction-${id} .transaction-title`).style.display = 'block';
    document.querySelector(`#transaction-${id} .transaction-amount`).style.display = 'block';
    document.querySelector(`#transaction-${id} .transaction-type`).style.display = 'block';
    document.querySelector(`#transaction-${id} .transaction-category`).style.display = 'block';
    document.querySelector(`#transaction-${id} .transaction-date`).style.display = 'block';
    document.querySelector(`#transaction-${id} .edit-btn`).style.display = 'inline-block';

    document.querySelector(`#transaction-${id} .transaction-title-input`).style.display = 'none';
    document.querySelector(`#transaction-${id} .transaction-amount-input`).style.display = 'none';
    document.querySelector(`#transaction-${id} .transaction-type-input`).style.display = 'none';
    document.querySelector(`#transaction-${id} .transaction-category-input`).style.display = 'none';
    document.querySelector(`#transaction-${id} .transaction-date-input`).style.display = 'none';
    document.querySelector(`#transaction-${id} .apply-btn`).style.display = 'none';
    document.querySelector(`#transaction-${id} .cancel-btn`).style.display = 'none';
}

// Toggle filter form visibility
document.getElementById('filter-icon').addEventListener('click', function() {
    const filterForm = document.getElementById('filter-form');
    if (filterForm.style.display === 'none') {
        filterForm.style.display = 'block';
    } else {
        filterForm.style.display = 'none';
    }
});

// Sorting functionality
function sortTable(tbodyId, colIndex, type) {

    const tbody = document.getElementById(tbodyId);
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const sortedRows = rows.sort((a, b) => {
        let aText = a.children[colIndex].innerText.toLowerCase();
        let bText = b.children[colIndex].innerText.toLowerCase();

        if (type === 'number') {
            aText = parseFloat(aText.replace(/[^0-9.-]+/g, ""));
            bText = parseFloat(bText.replace(/[^0-9.-]+/g, ""));
        } else if (type === 'date') {
            aText = new Date(aText);
            bText = new Date(bText);
        }

        if (aText < bText) return -1;
        if (aText > bText) return 1;
        return 0;
    });

    // Toggle sort direction
    if (this.sortDirection === 'asc') {
        sortedRows.reverse();
        this.sortDirection = 'desc';
    } else {
        this.sortDirection = 'asc';
    }

    // Remove existing rows
    while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
    }

    // Append sorted rows
    sortedRows.forEach(row => tbody.appendChild(row));
}

document.getElementById('sort-title').addEventListener('click', function(event) {
    event.preventDefault();
    sortTable('transactions-body', 0,'string');
});

document.getElementById('sort-amount').addEventListener('click', function(event) {
    event.preventDefault();
    sortTable('transactions-body', 1,'number');
});

document.getElementById('sort-type').addEventListener('click', function(event) {
    event.preventDefault();
    sortTable('transactions-body', 2,'string');
});
document.getElementById('sort-category').addEventListener('click', function(event) {
    event.preventDefault();
    sortTable('transactions-body', 3,'string');
});
document.getElementById('sort-date').addEventListener('click', function(event) {
    event.preventDefault();
    sortTable('transactions-body', 4,'date');
});


// Default sort by date
sortTable('transactions-body', 4,'date');

//Chart
const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
const incomeExpenseChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: JSON.parse('{{ labels|tojson }}'),
        datasets: [
            {
                label: 'Income',
                data: JSON.parse('{{ income_values|tojson }}'),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            },
            {
                label: 'Expense',
                data: JSON.parse('{{ expense_values|tojson }}'),
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                stacked: true
            },
            y: {
                beginAtZero: true,
                stacked: true
            }
        }
    }
});

$('#pieChartModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var type = button.data('type');
    var modal = $(this);
    modal.find('.modal-title').text('Pie Chart of ' + type.charAt(0).toUpperCase() + type.slice(1));
    modal.find('#pieChartImage').attr('src', '/pie_chart/' + type);
});

</script>
{% endblock %}